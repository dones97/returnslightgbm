name: Weekly Screening - Screener.in Database

on:
  schedule:
    # Run every Sunday at 2 AM UTC
    - cron: '0 2 * * 0'
  workflow_dispatch:  # Allow manual trigger

jobs:
  screen-stocks:
    runs-on: ubuntu-latest
    timeout-minutes: 60

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.10'

      - name: Install dependencies
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy lightgbm scikit-learn requests beautifulsoup4

      - name: Check for required files
        run: |
          if [ ! -f "screener_data.db" ]; then
            echo "[ERROR] screener_data.db not found!"
            exit 1
          fi

          if [ ! -f "trained_model_screener.pkl" ]; then
            echo "[ERROR] trained_model_screener.pkl not found!"
            exit 1
          fi

          echo "[OK] All required files found"
          ls -lh screener_data.db trained_model_screener.pkl

      - name: Run screening
        run: python scripts/screening_screener.py

      - name: Upload screening results
        uses: actions/upload-artifact@v4
        with:
          name: screening-results-screener
          path: |
            screening_results_screener.pkl
            screening_results_screener_*.csv
          retention-days: 30

      - name: Commit screening results
        run: |
          # Configure git
          git config --local user.email "action@github.com"
          git config --local user.name "GitHub Action"

          # Add results
          git add screening_results_screener.pkl
          git add screening_results_screener_*.csv

          # Commit if there are changes
          git diff --quiet && git diff --staged --quiet || (
            # Get stats from latest CSV
            latest_csv=$(ls -t screening_results_screener_*.csv | head -1)
            total_stocks=$(wc -l < "$latest_csv")
            total_stocks=$((total_stocks - 1))  # Subtract header

            git commit -m "Auto: Weekly screening results - Screener.in DB ($(date +'%Y-%m-%d'))" \
                       -m "Screened $total_stocks stocks" \
                       -m "Results in screening_results_screener.pkl and CSV"

            # Pull with rebase to avoid conflicts
            git pull --rebase origin main

            # Push to repository
            git push
          )

      - name: Summary
        if: always()
        run: |
          echo "Screening workflow completed"
          if [ -f "screening_results_screener.pkl" ]; then
            echo "[OK] Results file created"

            # Show summary using Python
            python << 'EOF'
          import pandas as pd

          try:
              results = pd.read_pickle('screening_results_screener.pkl')
              print(f"\n[SUMMARY]")
              print(f"Total stocks: {len(results)}")
              print(f"Strong Buy: {sum(results['Category'] == 'Strong Buy')}")
              print(f"Buy: {sum(results['Category'] == 'Buy')}")
              print(f"Neutral: {sum(results['Category'] == 'Neutral')}")
              print(f"Mean predicted return: {results['Predicted_Return'].mean():.2f}%")
          except Exception as e:
              print(f"Could not load results: {e}")
          EOF
          fi
